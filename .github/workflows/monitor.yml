name: Monitor Reservas Pádel

on:
  # Ejecución programada (UTC -3 horas para Argentina)
  schedule:
    # Miércoles 21:50-23:00 (cada 10 minutos) → UTC: 00:50-02:00
    - cron: '50 0 * * 3'  # Miércoles 00:50 UTC
    - cron: '0 1 * * 3'   # Miércoles 01:00 UTC
    - cron: '10 1 * * 3'  # Miércoles 01:10 UTC
    - cron: '20 1 * * 3'  # Miércoles 01:20 UTC
    - cron: '30 1 * * 3'  # Miércoles 01:30 UTC
    - cron: '40 1 * * 3'  # Miércoles 01:40 UTC
    - cron: '50 1 * * 3'  # Miércoles 01:50 UTC
    - cron: '0 2 * * 3'   # Miércoles 02:00 UTC
    - cron: '10 2 * * 3'  # Miércoles 02:10 UTC
    - cron: '20 2 * * 3'  # Miércoles 02:20 UTC
    - cron: '30 2 * * 3'  # Miércoles 02:30 UTC
    
    # Jueves 06:00-07:00 (cada 15 minutos) → UTC: 09:00-10:00
    - cron: '0 9 * * 4'   # Jueves 09:00 UTC
    - cron: '15 9 * * 4'  # Jueves 09:15 UTC
    - cron: '30 9 * * 4'  # Jueves 09:30 UTC
    - cron: '45 9 * * 4'  # Jueves 09:45 UTC
    
  # Ejecución manual desde GitHub
  workflow_dispatch:
    inputs:
      descripcion:
        description: 'Descripción de la ejecución manual'
        required: false
        default: 'Ejecución manual iniciada'

jobs:
  monitor:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout código
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Instalar Chrome para Selenium
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
    
    - name: Instalar dependencias Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Verificar instalaciones
      run: |
        python --version
        google-chrome --version
        echo "Chrome instalado correctamente"
    
    - name: Ejecutar monitor
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        USUARIO_CLUB: ${{ secrets.USUARIO_CLUB }}
        PASSWORD_CLUB: ${{ secrets.PASSWORD_CLUB }}
      run: |
        python monitor.py
    
    - name: Notificar falla
      if: failure()
      run: |
        echo "❌ La ejecución falló - Revisa los logs de arriba"
        echo "Posibles causas:"
        echo "1. URLs incorrectas en monitor.py"
        echo "2. Credenciales inválidas en Secrets"
        echo "3. Cambios en la página del club"
        echo "4. Problemas de conectividad"
