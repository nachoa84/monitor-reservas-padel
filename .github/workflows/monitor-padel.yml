name: Monitor P√°del - Versi√≥n Funcional

on:
  workflow_dispatch:
  schedule:
    # Mi√©rcoles 21:50 a 23:50 (hora Argentina, UTC-3)
    - cron: '50 0 * * 3'    # 21:50 ARG
    - cron: '0 1 * * 3'     # 22:00 ARG
    - cron: '10 1 * * 3'    # 22:10 ARG
    - cron: '20 1 * * 3'    # 22:20 ARG
    - cron: '30 1 * * 3'    # 22:30 ARG
    - cron: '40 1 * * 3'    # 22:40 ARG
    - cron: '50 1 * * 3'    # 22:50 ARG
    - cron: '0 2 * * 3'     # 23:00 ARG
    - cron: '10 2 * * 3'    # 23:10 ARG
    - cron: '20 2 * * 3'    # 23:20 ARG
    - cron: '30 2 * * 3'    # 23:30 ARG
    
    # Jueves 06:00 a 08:00 (hora Argentina, UTC-3)
    - cron: '0 9 * * 4'     # 06:00 ARG
    - cron: '15 9 * * 4'    # 06:15 ARG
    - cron: '30 9 * * 4'    # 06:30 ARG
    - cron: '45 9 * * 4'    # 06:45 ARG
    - cron: '0 10 * * 4'    # 07:00 ARG
    - cron: '15 10 * * 4'   # 07:15 ARG
    - cron: '30 10 * * 4'   # 07:30 ARG
    - cron: '45 10 * * 4'   # 07:45 ARG

jobs:
  monitor-padel:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout c√≥digo
      uses: actions/checkout@v4
    
    - name: Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Instalar Chrome
      run: |
        # Instalar Chrome usando m√©todo moderno
        sudo apt-get update
        sudo apt-get install -y wget
        
        # Agregar repositorio Chrome correctamente
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo gpg --dearmor -o /usr/share/keyrings/google-chrome.gpg
        echo "deb [arch=amd64 signed-by=/usr/share/keyrings/google-chrome.gpg] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        # Verificar versi√≥n
        echo "‚úÖ Chrome instalado:"
        google-chrome --version
    
    - name: Instalar dependencias Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
        # Verificar que webdriver-manager funciona
        python -c "
import os
os.environ['WDM_LOCAL'] = '0'
os.environ['WDM_SSL_VERIFY'] = '0'
os.environ['WDM_LOG_LEVEL'] = '0'
print('‚úÖ Configuraci√≥n webdriver-manager completada')
        "
    
    - name: Configurar webdriver-manager para GitHub Actions
      run: |
        # Crear directorio para cache de webdriver-manager
        mkdir -p ~/.wdm
        chmod -R 755 ~/.wdm
        
        # Configurar variables de entorno
        echo "WDM_LOCAL=0" >> $GITHUB_ENV
        echo "WDM_SSL_VERIFY=0" >> $GITHUB_ENV
        echo "WDM_LOG_LEVEL=0" >> $GITHUB_ENV
    
    - name: Verificar instalaciones
      run: |
        echo "=== VERIFICACI√ìN DE INSTALACIONES ==="
        echo "Python: $(python --version)"
        echo "Chrome: $(google-chrome --version)"
        echo "Pip: $(pip --version)"
        
        # Verificar que podemos importar webdriver_manager
        python -c "
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager

print('‚úÖ Importaciones exitosas')
print('‚úÖ ChromeDriverManager disponible')
        "
    
    - name: Ejecutar monitor de reservas
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        USUARIO_CLUB: ${{ secrets.USUARIO_CLUB }}
        PASSWORD_CLUB: ${{ secrets.PASSWORD_CLUB }}
        # Variables para webdriver-manager
        WDM_LOCAL: "0"
        WDM_SSL_VERIFY: "0"
        WDM_LOG_LEVEL: "0"
      run: |
        echo "üèì Iniciando monitor de reservas de p√°del..."
        echo "URLs configuradas:"
        echo "- Login: https://www.tirofederalgchu.com/web/mi-cuenta/"
        echo "- Reservas: https://www.tirofederalgchu.com/web/producto/canchas-padel/"
        
        # Crear directorio para logs
        mkdir -p logs
        
        # Ejecutar script con redirecci√≥n de logs
        python monitor.py 2>&1 | tee logs/monitor-$(date +%Y%m%d-%H%M%S).log
        
        # Verificar resultado
        if [ ${PIPESTATUS[0]} -eq 0 ]; then
          echo "‚úÖ Monitor ejecutado exitosamente"
        else
          echo "‚ùå Error en la ejecuci√≥n del monitor"
          exit 1
        fi
    
    - name: Subir logs en caso de error
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: logs-monitor-failed
        path: |
          logs/
          *.png
          debug_*.html
        retention-days: 3
