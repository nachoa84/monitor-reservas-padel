name: ü§ñ Monitor P√°del - Versi√≥n Corregida

on:
  workflow_dispatch:
  schedule:
    # Mi√©rcoles 21:50 a 23:50 (hora Argentina, UTC-3)
    - cron: '50 0 * * 3'    # 21:50 ARG
    - cron: '0 1 * * 3'     # 22:00 ARG
    - cron: '10 1 * * 3'    # 22:10 ARG
    - cron: '20 1 * * 3'    # 22:20 ARG
    - cron: '30 1 * * 3'    # 22:30 ARG
    - cron: '40 1 * * 3'    # 22:40 ARG
    - cron: '50 1 * * 3'    # 22:50 ARG
    - cron: '0 2 * * 3'     # 23:00 ARG
    - cron: '10 2 * * 3'    # 23:10 ARG
    - cron: '20 2 * * 3'    # 23:20 ARG
    - cron: '30 2 * * 3'    # 23:30 ARG
    - cron: '40 2 * * 3'    # 23:40 ARG
    - cron: '50 2 * * 3'    # 23:50 ARG
    
    # Jueves 06:00 a 08:00 (hora Argentina, UTC-3)
    - cron: '0 9 * * 4'     # 06:00 ARG
    - cron: '15 9 * * 4'    # 06:15 ARG
    - cron: '30 9 * * 4'    # 06:30 ARG
    - cron: '45 9 * * 4'    # 06:45 ARG
    - cron: '0 10 * * 4'    # 07:00 ARG
    - cron: '15 10 * * 4'   # 07:15 ARG
    - cron: '30 10 * * 4'   # 07:30 ARG
    - cron: '45 10 * * 4'   # 07:45 ARG
    - cron: '0 11 * * 4'    # 08:00 ARG

jobs:
  monitor:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
    - name: üì• Checkout c√≥digo
      uses: actions/checkout@v3
    
    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: üåê Instalar Google Chrome
      run: |
        echo "üì¶ Instalando Google Chrome..."
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        
        wget -q -O - https://dl-ssl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
        echo "‚úÖ Chrome instalado:"
        google-chrome --version
    
    - name: üì¶ Instalar dependencias Python
      run: |
        echo "üì¶ Instalando dependencias..."
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        echo "‚úÖ Dependencias instaladas"
    
    - name: ‚öôÔ∏è Configurar variables de entorno
      run: |
        echo "WDM_LOCAL=0" >> $GITHUB_ENV
        echo "WDM_SSL_VERIFY=0" >> $GITHUB_ENV
        echo "WDM_LOG_LEVEL=0" >> $GITHUB_ENV
        echo "GITHUB_ACTIONS=true" >> $GITHUB_ENV
        
        mkdir -p ~/.wdm
        chmod -R 755 ~/.wdm
        
        echo "‚úÖ Variables de entorno configuradas"
    
    - name: üîç Verificar instalaciones
      run: |
        echo "=== üîç VERIFICACI√ìN DE INSTALACIONES ==="
        echo "Python: $(python --version)"
        echo "Chrome: $(google-chrome --version)"
        echo "Pip packages:"
        pip list | grep -E "selenium|webdriver"
        
        python << 'EOF'
from selenium import webdriver
from selenium.webdriver.chrome.service import Service
from webdriver_manager.chrome import ChromeDriverManager
print('‚úÖ Todas las importaciones exitosas')
EOF
    
    - name: ü§ñ Ejecutar monitor de reservas
      env:
        TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        USUARIO_CLUB: ${{ secrets.USUARIO_CLUB }}
        PASSWORD_CLUB: ${{ secrets.PASSWORD_CLUB }}
        WDM_LOCAL: "0"
        WDM_SSL_VERIFY: "0"
        WDM_LOG_LEVEL: "0"
        GITHUB_ACTIONS: "true"
      run: |
        echo "üèÉ Iniciando monitor de reservas de p√°del..."
        echo "üïí Timestamp: $(date)"
        echo ""
        
        python monitor.py 2>&1 | tee monitor.log
        
        EXIT_CODE=${PIPESTATUS[0]}
        
        echo ""
        echo "=== üìä RESULTADO ==="
        if [ $EXIT_CODE -eq 0 ]; then
          echo "‚úÖ Monitor ejecutado exitosamente"
        else
          echo "‚ùå Error en la ejecuci√≥n (c√≥digo: $EXIT_CODE)"
          exit $EXIT_CODE
        fi
    
    - name: üì§ Subir logs si hay error
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: logs-monitor-error-${{ github.run_number }}
        path: |
          monitor.log
          *.png
          *.html
        retention-days: 3
    
    - name: ‚ùå Mensaje de error
      if: failure()
      run: |
        echo "‚ùå La ejecuci√≥n fall√≥"
        echo "Revisa los logs arriba"
